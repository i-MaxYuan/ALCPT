{% extends "base.html" %}
{% load staticfiles %}
{% load web_filters %}
{% block scripts %}
<script src="{% static "scripts/question.js" %}" defer></script>
<script type="text/javascript" defer>
$(function() {
    {% if question %}
    let options = {{ question.option|safe }};
    for (let i = 0; i < options.length; ++i) {
        $("#add-option").trigger("click");
        $("#option-" + i).val(options[i]);
        update_option(i);
    }
    $("input[type=radio][name=answer][value={{ question.answer }}]").trigger("click");

    $(".custom-file-label").html("{{ question.question_file }}");
    $("#preview-audio-source").attr("src", "{{ question.question_file }}");
    document.getElementById("preview-audio").load();
    {% else %}
    for (let i = 0; i < 4; ++i) {
        $("#add-option").trigger("click");
    }
    $("input[type=radio][name=answer][value=0]").trigger("click");
    {% endif %}
});
</script>
{% endblock %}

{% block content %}
<section class="row">
    <section class="col mb-3">
        <h1 style="display: inline;">{% if question %}編輯{% else %}新增{% endif %}題目：聽力／問答</h1>
    </section>
    {% if request.user|has_perm:'QuestionManager' %}
    <form class="col-12 row mt-3" enctype="multipart/form-data" action="/question/{% if question %}{{ question.id }}/edit{% else %}create{% endif %}" method="post" autocomplete="off">
    {% else %}
    <form class="col-12 row mt-3" enctype="multipart/form-data" action="/question_operator/{% if question %}{{ question.id }}/edit{% else %}create{% endif %}" method="post" autocomplete="off">
    {% endif %}
        {% csrf_token %}

        {% if question %}
        <input type="hidden" name="next" value="{{ next }}" />
        {% else %}
        <input type="hidden" name="type" value="{{ question_type }}" />
        {% endif %}

        <h3 class="col-12"><i class="fa fa-upload fa-fw mb-2"></i> 上傳音訊檔案</h3>

        <div class="col-12 py-2 form-group">
            <label class="custom-file col-12">
                <input type="file" id="audio-file" name="audio" class="custom-file-input" accept="audio/mpeg" {% if not question %}required{% endif %}>
                <label class="custom-file-label" for="audio-file">No file selected</label>
            </label>
        </div>

        <h3 class="col-12"><i class="fa  fa-tasks fa-fw mb-2"></i> 難易度</h3>
        <div class="col-12 py-2 form-group">
            <select class="custom-select" name="difficult">
                <option value="1" {% if question.difficult is 1 %} selected {% endif %}>簡單</option>
                <option value="2" {% if question.difficult is 2 %} selected {% endif %}>中等</option>
                <option value="3" {% if question.difficult is 3 %} selected {% endif %}>困難</option>
            </select>
        </div>

        <section class="col-12 py-2">
            <section class="row align-items-center">
                <div class="col-auto mr-auto">
                    <h3 style="display: inline;"><i class="fa fa-th-list fa-fw"></i> 編輯選項</h3>
                </div>
                <div class="col-auto">
                    <a href="#" id="add-option" class="btn btn-success"><i class="fa fa-plus"></i> 新增選項</a>
                </div>
            </section>
        </section>

        <section id="options" class="col-12 pt-2"></section>

        <section class="col-12 pt-3">
            <section class="row">
                <h3 class="col"><i class="fa fa-eye fa-fw mb-2"></i> 預覽</h3>
                <div class="w-100 mt-2"></div>

                <section class="col-12">
                    <section class="card">
                        <section class="card-body">
                            <audio id="preview-audio" controls>
                                <source id="preview-audio-source" type="audio/mpeg">
                                Your browser does not support the audio tag.
                            </audio>
                            <section id="answers" class="pt-2"></section>
                        </section>
                    </section>
                </section>
            </section>
        </section>

        <section class="col text-center pt-3">
            <button class="btn btn-primary" type="submit">{% if question %}編輯{% else %}新增{% endif %}題目</button>
        </section>
    </form>
</section>
{% endblock %}
